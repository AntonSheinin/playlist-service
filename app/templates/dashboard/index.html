{% extends "base.html" %}

{% block title %}Dashboard - Playlist Service{% endblock %}

{% block content %}
<div class="space-y-6">
    <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>

    <!-- Stats cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Channels -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-100 rounded-md p-3">
                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Channels</p>
                    <p class="text-2xl font-semibold text-gray-900" id="stat-channels">-</p>
                    <p class="text-xs text-gray-500"><span id="stat-channels-synced">-</span> synced, <span id="stat-channels-orphaned" class="text-orange-600">-</span> orphaned</p>
                </div>
            </div>
            <a href="/channels" class="mt-4 block text-sm text-blue-600 hover:text-blue-800">View All &rarr;</a>
        </div>

        <!-- Groups -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-green-100 rounded-md p-3">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Groups</p>
                    <p class="text-2xl font-semibold text-gray-900" id="stat-groups">-</p>
                </div>
            </div>
            <a href="/groups" class="mt-4 block text-sm text-blue-600 hover:text-blue-800">View All &rarr;</a>
        </div>

        <!-- Packages & Tariffs -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-purple-100 rounded-md p-3">
                    <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Packages / Tariffs</p>
                    <p class="text-2xl font-semibold text-gray-900"><span id="stat-packages">-</span> / <span id="stat-tariffs">-</span></p>
                </div>
            </div>
            <a href="/packages" class="mt-4 block text-sm text-blue-600 hover:text-blue-800">View All &rarr;</a>
        </div>

        <!-- Users -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-yellow-100 rounded-md p-3">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Users</p>
                    <p class="text-2xl font-semibold text-gray-900" id="stat-users">-</p>
                    <p class="text-xs text-gray-500"><span id="stat-users-enabled" class="text-green-600">-</span> enabled, <span id="stat-users-disabled" class="text-red-600">-</span> disabled</p>
                </div>
            </div>
            <a href="/users" class="mt-4 block text-sm text-blue-600 hover:text-blue-800">View All &rarr;</a>
        </div>
    </div>

    <!-- Flussonic Sync -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-800">Flussonic Sync</h2>
                <p class="text-sm text-gray-600 mt-1">
                    Last sync: <span id="last-sync" class="font-medium">Never</span>
                </p>
            </div>
            <button onclick="syncChannels()" id="sync-button"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Sync from Flussonic
            </button>
        </div>
        <div id="sync-result" class="mt-4 hidden">
            <div class="bg-green-50 border border-green-200 rounded-md p-4">
                <p class="text-sm text-green-800">
                    Sync completed: <span id="sync-total">0</span> total channels,
                    <span id="sync-new">0</span> new,
                    <span id="sync-updated">0</span> updated,
                    <span id="sync-orphaned">0</span> orphaned
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', loadStats);

    async function loadStats() {
        try {
            const response = await fetch('/api/v1/dashboard/stats');
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error('Failed to load stats');
            }

            const data = await response.json();
            const stats = data.data;

            document.getElementById('stat-channels').textContent = stats.channels_total;
            document.getElementById('stat-channels-synced').textContent = stats.channels_synced;
            document.getElementById('stat-channels-orphaned').textContent = stats.channels_orphaned;
            document.getElementById('stat-groups').textContent = stats.groups;
            document.getElementById('stat-packages').textContent = stats.packages;
            document.getElementById('stat-tariffs').textContent = stats.tariffs;
            document.getElementById('stat-users').textContent = stats.users;
            document.getElementById('stat-users-enabled').textContent = stats.users_enabled;
            document.getElementById('stat-users-disabled').textContent = stats.users_disabled;

            if (stats.last_sync) {
                const date = new Date(stats.last_sync);
                document.getElementById('last-sync').textContent = date.toLocaleString();
            }
        } catch (error) {
            console.error('Failed to load stats:', error);
            showToast('Failed to load dashboard statistics', 'error');
        }
    }

    async function syncChannels() {
        const button = document.getElementById('sync-button');
        button.disabled = true;
        button.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Syncing...';

        try {
            const response = await fetch('/api/v1/channels/sync', { method: 'POST' });
            const data = await response.json();

            if (response.ok && data.success) {
                const result = data.data;
                document.getElementById('sync-total').textContent = result.total;
                document.getElementById('sync-new').textContent = result.new;
                document.getElementById('sync-updated').textContent = result.updated;
                document.getElementById('sync-orphaned').textContent = result.orphaned;
                document.getElementById('sync-result').classList.remove('hidden');

                showToast('Channels synchronized successfully', 'success');
                loadStats();
            } else {
                showToast(data.error?.message || 'Sync failed', 'error');
            }
        } catch (error) {
            console.error('Sync failed:', error);
            showToast('Failed to sync channels', 'error');
        } finally {
            button.disabled = false;
            button.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Sync from Flussonic';
        }
    }
</script>
{% endblock %}
