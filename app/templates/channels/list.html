{% extends "base.html" %}

{% block title %}Channels - Playlist Service{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800">Channels</h1>
        <button onclick="syncChannels()" id="sync-button"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            Sync from Flussonic
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Group</label>
                <select id="filter-group" onchange="loadChannels()"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Groups</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Status</label>
                <select id="filter-status" onchange="loadChannels()"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="synced">Synced</option>
                    <option value="orphaned">Orphaned</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">Search</label>
                <input type="text" id="filter-search" placeholder="Search channels..."
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </div>

    <!-- Channels table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="w-10 px-4 py-3"></th>
                    <th class="w-16 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Logo</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TVG ID</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Group</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Packages</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody id="channels-tbody" class="bg-white divide-y divide-gray-200">
                <!-- Rows loaded via JS -->
            </tbody>
        </table>

        <!-- Pagination -->
        <div id="pagination" class="px-4 py-3 border-t border-gray-200"></div>
    </div>
</div>

<!-- Edit Channel Modal Template -->
<template id="edit-channel-modal">
    <div class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700">Stream Name</label>
            <input type="text" id="edit-stream-name" readonly
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Display Name</label>
            <input type="text" id="edit-display-name" readonly
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">TVG ID (EPG ID)</label>
            <input type="text" id="edit-tvg-id"
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Logo</label>
            <div class="mt-1 flex items-center space-x-4">
                <img id="edit-logo-preview" src="" alt="" class="w-16 h-16 object-contain border rounded hidden">
                <input type="file" id="edit-logo-file" accept="image/*" class="hidden">
                <button type="button" onclick="document.getElementById('edit-logo-file').click()"
                        class="px-3 py-2 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50">
                    Choose File
                </button>
                <button type="button" onclick="removeLogo()"
                        class="px-3 py-2 border border-red-300 rounded-md text-sm text-red-700 hover:bg-red-50">
                    Remove
                </button>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Catchup Days</label>
            <input type="text" id="edit-catchup-days" readonly
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500">
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let currentChannelId = null;
    let groups = [];
    let packages = [];
    let searchTimeout = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await Promise.all([loadGroups(), loadPackages()]);
        loadChannels();

        document.getElementById('filter-search').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadChannels(), 300);
        });

        document.getElementById('edit-logo-file').addEventListener('change', handleLogoUpload);
    });

    async function loadGroups() {
        const response = await fetch('/api/v1/lookup/groups');
        const data = await response.json();
        groups = data.data;

        const select = document.getElementById('filter-group');
        groups.forEach(g => {
            const option = document.createElement('option');
            option.value = g.id;
            option.textContent = g.name;
            select.appendChild(option);
        });
    }

    async function loadPackages() {
        const response = await fetch('/api/v1/lookup/packages');
        const data = await response.json();
        packages = data.data;
    }

    async function loadChannels(page = 1) {
        currentPage = page;
        const groupId = document.getElementById('filter-group').value;
        const status = document.getElementById('filter-status').value;
        const search = document.getElementById('filter-search').value;

        let url = `/api/v1/channels?page=${page}&per_page=20`;
        if (groupId) url += `&group_id=${groupId}`;
        if (status) url += `&sync_status=${status}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;

        try {
            const response = await fetch(url);
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            renderChannels(data.data);
        } catch (error) {
            console.error('Failed to load channels:', error);
            showToast('Failed to load channels', 'error');
        }
    }

    function renderChannels(data) {
        const tbody = document.getElementById('channels-tbody');
        tbody.innerHTML = '';

        data.items.forEach((channel, index) => {
            const row = document.createElement('tr');
            row.className = channel.sync_status === 'orphaned' ? 'bg-gray-50 text-gray-500' : '';
            row.innerHTML = `
                <td class="px-4 py-3">
                    <span class="cursor-move text-gray-400">&#9776;</span>
                </td>
                <td class="px-4 py-3">
                    ${channel.tvg_logo ?
                        `<img src="${channel.tvg_logo}" class="w-10 h-10 object-contain">` :
                        '<span class="text-gray-400">-</span>'}
                </td>
                <td class="px-4 py-3">
                    <div class="font-medium">${escapeHtml(channel.display_name || channel.stream_name)}</div>
                    <div class="text-xs text-gray-500">${escapeHtml(channel.stream_name)}</div>
                </td>
                <td class="px-4 py-3">
                    <span class="text-sm">${escapeHtml(channel.tvg_id || '-')}</span>
                </td>
                <td class="px-4 py-3">
                    <select onchange="updateChannelGroup(${channel.id}, this.value)"
                            class="block w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">No Group</option>
                        ${groups.map(g => `<option value="${g.id}" ${channel.group_id === g.id ? 'selected' : ''}>${escapeHtml(g.name)}</option>`).join('')}
                    </select>
                </td>
                <td class="px-4 py-3">
                    <button onclick="editChannelPackages(${channel.id})" class="text-sm text-blue-600 hover:text-blue-800">
                        ${channel.packages.length} packages
                    </button>
                </td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${channel.sync_status === 'synced' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                        ${channel.sync_status}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <button onclick="editChannel(${channel.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-2">Edit</button>
                    ${channel.sync_status === 'orphaned' ?
                        `<button onclick="deleteChannel(${channel.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>` : ''}
                </td>
            `;
            tbody.appendChild(row);
        });

        renderPagination(data);
    }

    function renderPagination(data) {
        const container = document.getElementById('pagination');
        if (data.pages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '<div class="flex items-center justify-between"><div class="text-sm text-gray-700">';
        html += `Page ${data.page} of ${data.pages} (${data.total} channels)</div><div class="flex space-x-2">`;

        if (data.page > 1) {
            html += `<button onclick="loadChannels(${data.page - 1})" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Previous</button>`;
        }
        if (data.page < data.pages) {
            html += `<button onclick="loadChannels(${data.page + 1})" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Next</button>`;
        }

        html += '</div></div>';
        container.innerHTML = html;
    }

    async function updateChannelGroup(channelId, groupId) {
        try {
            const response = await fetch(`/api/v1/channels/${channelId}/group`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_id: groupId ? parseInt(groupId) : null })
            });

            if (response.ok) {
                showToast('Group updated', 'success');
            } else {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to update group', 'error');
            }
        } catch (error) {
            showToast('Failed to update group', 'error');
        }
    }

    async function editChannel(channelId) {
        currentChannelId = channelId;

        const response = await fetch(`/api/v1/channels/${channelId}`);
        const data = await response.json();
        const channel = data.data;

        const template = document.getElementById('edit-channel-modal').content.cloneNode(true);
        const container = document.createElement('div');
        container.appendChild(template);

        showModal(`Edit Channel: ${channel.display_name || channel.stream_name}`, container.innerHTML, [
            { text: 'Cancel', class: 'bg-gray-200 text-gray-800 hover:bg-gray-300', onclick: 'closeModal()' },
            { text: 'Save', class: 'bg-blue-600 text-white hover:bg-blue-700', onclick: 'saveChannel()' }
        ]);

        document.getElementById('edit-stream-name').value = channel.stream_name;
        document.getElementById('edit-display-name').value = channel.display_name || '';
        document.getElementById('edit-tvg-id').value = channel.tvg_id || '';
        document.getElementById('edit-catchup-days').value = channel.catchup_days || '-';

        if (channel.tvg_logo) {
            const preview = document.getElementById('edit-logo-preview');
            preview.src = channel.tvg_logo;
            preview.classList.remove('hidden');
        }
    }

    function handleLogoUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('edit-logo-preview');
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function removeLogo() {
        const preview = document.getElementById('edit-logo-preview');
        preview.src = '';
        preview.classList.add('hidden');
        document.getElementById('edit-logo-file').value = '';
    }

    async function saveChannel() {
        const tvgId = document.getElementById('edit-tvg-id').value;
        const preview = document.getElementById('edit-logo-preview');
        const tvgLogo = preview.classList.contains('hidden') ? '' : preview.src;

        try {
            const response = await fetch(`/api/v1/channels/${currentChannelId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tvg_id: tvgId, tvg_logo: tvgLogo })
            });

            if (response.ok) {
                closeModal();
                loadChannels(currentPage);
                showToast('Channel updated', 'success');
            } else {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to update channel', 'error');
            }
        } catch (error) {
            showToast('Failed to update channel', 'error');
        }
    }

    async function editChannelPackages(channelId) {
        const response = await fetch(`/api/v1/channels/${channelId}`);
        const data = await response.json();
        const channel = data.data;
        currentChannelId = channelId;

        const selectedIds = channel.packages.map(p => p.id);

        const content = `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Packages</label>
                <select id="packages-select" multiple class="w-full">
                    ${packages.map(p => `<option value="${p.id}" ${selectedIds.includes(p.id) ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
                </select>
            </div>
        `;

        showModal(`Edit Packages: ${channel.display_name || channel.stream_name}`, content, [
            { text: 'Cancel', class: 'bg-gray-200 text-gray-800 hover:bg-gray-300', onclick: 'closeModal()' },
            { text: 'Save', class: 'bg-blue-600 text-white hover:bg-blue-700', onclick: 'saveChannelPackages()' }
        ]);

        new TomSelect('#packages-select', { plugins: ['remove_button'] });
    }

    async function saveChannelPackages() {
        const select = document.getElementById('packages-select');
        const packageIds = Array.from(select.selectedOptions).map(o => parseInt(o.value));

        try {
            const response = await fetch(`/api/v1/channels/${currentChannelId}/packages`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ package_ids: packageIds })
            });

            if (response.ok) {
                closeModal();
                loadChannels(currentPage);
                showToast('Packages updated', 'success');
            } else {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to update packages', 'error');
            }
        } catch (error) {
            showToast('Failed to update packages', 'error');
        }
    }

    async function deleteChannel(channelId) {
        const infoResponse = await fetch(`/api/v1/channels/${channelId}/cascade-info`);
        const infoData = await infoResponse.json();
        const info = infoData.data;

        const details = [];
        if (info.packages > 0) details.push(`${info.packages} packages`);
        if (info.users > 0) details.push(`${info.users} users`);

        const message = details.length > 0
            ? `This will remove it from: ${details.join(', ')}`
            : 'This channel is not assigned to any packages or users.';

        showConfirm(
            'Delete Channel',
            'Are you sure you want to delete this orphaned channel?',
            message,
            async () => {
                try {
                    const response = await fetch(`/api/v1/channels/${channelId}`, { method: 'DELETE' });
                    if (response.ok) {
                        loadChannels(currentPage);
                        showToast('Channel deleted', 'success');
                    } else {
                        const data = await response.json();
                        showToast(data.error?.message || 'Failed to delete channel', 'error');
                    }
                } catch (error) {
                    showToast('Failed to delete channel', 'error');
                }
            }
        );
    }

    async function syncChannels() {
        const button = document.getElementById('sync-button');
        button.disabled = true;
        button.textContent = 'Syncing...';

        try {
            const response = await fetch('/api/v1/channels/sync', { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
                showToast(`Sync complete: ${data.data.new} new, ${data.data.updated} updated, ${data.data.orphaned} orphaned`, 'success');
                loadChannels(1);
            } else {
                showToast(data.error?.message || 'Sync failed', 'error');
            }
        } catch (error) {
            showToast('Failed to sync channels', 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'Sync from Flussonic';
        }
    }
</script>
{% endblock %}
