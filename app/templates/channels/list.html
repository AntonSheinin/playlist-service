{% extends "base.html" %}

{% block title %}Channels - Playlist Service{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800">Channels</h1>
        <div class="flex space-x-2">
            <button onclick="applyAllChanges()" id="apply-all-button"
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 hidden">
                Apply All (<span id="changes-count">0</span>)
            </button>
            <button onclick="syncChannels()" id="sync-button"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Sync from Flussonic
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Group</label>
                <select id="filter-group" onchange="loadChannels()"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Groups</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Status</label>
                <select id="filter-status" onchange="loadChannels()"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="synced">Synced</option>
                    <option value="orphaned">Orphaned</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">Search</label>
                <input type="text" id="filter-search" placeholder="Search channels..."
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </div>

    <!-- Channels table -->
    <div class="bg-white rounded-lg shadow overflow-hidden overflow-x-auto">
        <style>
            .resizable-table {
                table-layout: fixed;
            }
            .resizable-table th {
                position: relative;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .resizable-table td {
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .resizable-table th .resize-handle {
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 8px;
                cursor: col-resize;
                background: transparent;
                z-index: 10;
            }
            .resizable-table th .resize-handle:hover,
            .resizable-table th .resize-handle.resizing {
                background: #3b82f6;
            }
        </style>
        <table id="channels-table" class="min-w-full divide-y divide-gray-200 resizable-table" style="width: 100%;">
            <thead class="bg-gray-50">
                <tr>
                    <th class="w-10 px-2 py-3"></th>
                    <th class="w-16 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">#<span class="resize-handle"></span></th>
                    <th class="w-14 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Logo<span class="resize-handle"></span></th>
                    <th class="min-w-[150px] px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name<span class="resize-handle"></span></th>
                    <th class="w-28 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">TVG ID<span class="resize-handle"></span></th>
                    <th class="w-32 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Group<span class="resize-handle"></span></th>
                    <th class="w-16 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Archive<span class="resize-handle"></span></th>
                    <th class="w-40 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Packages<span class="resize-handle"></span></th>
                    <th class="w-20 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status<span class="resize-handle"></span></th>
                    <th class="w-24 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody id="channels-tbody" class="bg-white divide-y divide-gray-200">
                <!-- Rows loaded via JS -->
            </tbody>
        </table>

        <!-- Pagination -->
        <div id="pagination" class="px-4 py-3 border-t border-gray-200"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let currentChannelId = null;
    let groups = [];
    let packages = [];
    let searchTimeout = null;
    let pendingChanges = {};  // { channelId: { tvg_id, tvg_logo, channel_number } }

    document.addEventListener('DOMContentLoaded', async () => {
        await Promise.all([loadGroups(), loadPackages()]);
        loadChannels();
        initColumnResize();

        document.getElementById('filter-search').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadChannels(), 300);
        });
    });

    async function loadGroups() {
        const response = await fetch('/api/v1/lookup/groups');
        const data = await response.json();
        groups = data.data;

        const select = document.getElementById('filter-group');
        groups.forEach(g => {
            const option = document.createElement('option');
            option.value = g.id;
            option.textContent = g.name;
            select.appendChild(option);
        });
    }

    async function loadPackages() {
        const response = await fetch('/api/v1/lookup/packages');
        const data = await response.json();
        packages = data.data;
    }

    async function loadChannels(page = 1) {
        currentPage = page;
        const groupId = document.getElementById('filter-group').value;
        const status = document.getElementById('filter-status').value;
        const search = document.getElementById('filter-search').value;

        let url = `/api/v1/channels?page=${page}&per_page=20`;
        if (groupId) url += `&group_id=${groupId}`;
        if (status) url += `&sync_status=${status}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;

        try {
            const response = await fetch(url);
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            renderChannels(data.data);
        } catch (error) {
            console.error('Failed to load channels:', error);
            showToast('Failed to load channels', 'error');
        }
    }

    function renderChannels(data) {
        const tbody = document.getElementById('channels-tbody');
        tbody.innerHTML = '';

        data.items.forEach((channel, index) => {
            const pending = pendingChanges[channel.id] || {};
            const currentTvgId = pending.tvg_id !== undefined ? pending.tvg_id : (channel.tvg_id || '');
            const currentLogo = pending.tvg_logo !== undefined ? pending.tvg_logo : (channel.tvg_logo || '');
            const currentNumber = pending.channel_number !== undefined ? pending.channel_number : (channel.channel_number || '');
            const currentCatchup = pending.catchup_days !== undefined ? pending.catchup_days : (channel.catchup_days || '');
            const hasChanges = pendingChanges[channel.id] !== undefined;

            const row = document.createElement('tr');
            row.className = channel.sync_status === 'orphaned' ? 'bg-gray-50 text-gray-500' : '';
            if (hasChanges) row.classList.add('bg-yellow-50');
            row.innerHTML = `
                <td class="px-2 py-2">
                    <span class="cursor-move text-gray-400">&#9776;</span>
                </td>
                <td class="px-2 py-2">
                    <input type="number" min="0" max="9999"
                           value="${currentNumber}"
                           data-channel-id="${channel.id}"
                           data-field="channel_number"
                           data-original="${channel.channel_number || ''}"
                           onchange="trackChange(${channel.id}, 'channel_number', this.value)"
                           class="w-14 px-1 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </td>
                <td class="px-2 py-2">
                    ${currentLogo ?
                        `<img src="${currentLogo}" class="w-8 h-8 object-contain cursor-pointer" onclick="editLogo(${channel.id}, '${escapeHtml(currentLogo)}')" title="Click to change">` :
                        `<button onclick="editLogo(${channel.id}, '')" class="w-8 h-8 border border-dashed border-gray-300 rounded flex items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 text-xs" title="Add logo">+</button>`}
                </td>
                <td class="px-2 py-2">
                    <div class="font-medium text-sm">${escapeHtml(channel.display_name || channel.stream_name)}</div>
                    <div class="text-xs text-gray-500">${escapeHtml(channel.stream_name)}</div>
                </td>
                <td class="px-2 py-2">
                    <input type="text"
                           value="${escapeHtml(currentTvgId)}"
                           data-channel-id="${channel.id}"
                           data-field="tvg_id"
                           data-original="${escapeHtml(channel.tvg_id || '')}"
                           onchange="trackChange(${channel.id}, 'tvg_id', this.value)"
                           placeholder="-"
                           class="w-24 px-1 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </td>
                <td class="px-2 py-2">
                    <select onchange="updateChannelGroup(${channel.id}, this.value)"
                            class="w-full px-1 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">No Group</option>
                        ${groups.map(g => `<option value="${g.id}" ${channel.group_id === g.id ? 'selected' : ''}>${escapeHtml(g.name)}</option>`).join('')}
                    </select>
                </td>
                <td class="px-2 py-2">
                    <input type="number" min="0" max="365"
                           value="${currentCatchup}"
                           data-channel-id="${channel.id}"
                           data-field="catchup_days"
                           data-original="${channel.catchup_days || ''}"
                           onchange="trackChange(${channel.id}, 'catchup_days', this.value)"
                           placeholder="-"
                           class="w-12 px-1 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </td>
                <td class="px-2 py-2">
                    <div onclick="editChannelPackages(${channel.id})" class="cursor-pointer hover:bg-gray-100 rounded p-1" title="Click to edit packages">
                        ${channel.packages.length > 0
                            ? channel.packages.map(p => `<span class="inline-block text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded mr-1 mb-1">${escapeHtml(p.name)}</span>`).join('')
                            : '<span class="text-xs text-gray-400">-</span>'}
                    </div>
                </td>
                <td class="px-2 py-2">
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium ${channel.sync_status === 'synced' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                        ${channel.sync_status === 'synced' ? 'sync' : 'orph'}
                    </span>
                </td>
                <td class="px-2 py-2">
                    <div class="flex items-center space-x-1">
                        <button onclick="applyRowChanges(${channel.id})" class="text-xs px-2 py-1 rounded ${hasChanges ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" title="Save changes" ${hasChanges ? '' : 'disabled'}>Apply</button>
                        <button onclick="editChannel(${channel.id})" class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" title="Edit channel details">Edit</button>
                        <button onclick="deleteChannel(${channel.id})" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700" title="Delete channel">Del</button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        renderPagination(data);
    }

    function renderPagination(data) {
        const container = document.getElementById('pagination');
        if (data.pages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '<div class="flex items-center justify-between"><div class="text-sm text-gray-700">';
        html += `Page ${data.page} of ${data.pages} (${data.total} channels)</div><div class="flex space-x-2">`;

        if (data.page > 1) {
            html += `<button onclick="loadChannels(${data.page - 1})" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Previous</button>`;
        }
        if (data.page < data.pages) {
            html += `<button onclick="loadChannels(${data.page + 1})" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Next</button>`;
        }

        html += '</div></div>';
        container.innerHTML = html;
    }

    function trackChange(channelId, field, value) {
        if (!pendingChanges[channelId]) {
            pendingChanges[channelId] = { id: channelId };
        }

        if (field === 'channel_number' || field === 'catchup_days') {
            pendingChanges[channelId][field] = value ? parseInt(value) : null;
        } else {
            pendingChanges[channelId][field] = value;
        }

        highlightChangedRow(channelId);
        updateApplyAllButton();
        loadChannels(currentPage);  // Re-render to show Apply button
    }

    function updateApplyAllButton() {
        const count = Object.keys(pendingChanges).length;
        const button = document.getElementById('apply-all-button');
        const countSpan = document.getElementById('changes-count');

        if (count > 0) {
            button.classList.remove('hidden');
            countSpan.textContent = count;
        } else {
            button.classList.add('hidden');
        }
    }

    async function applyAllChanges() {
        const count = Object.keys(pendingChanges).length;
        if (count === 0) return;

        const button = document.getElementById('apply-all-button');
        button.disabled = true;
        button.textContent = 'Saving...';

        try {
            const channels = Object.values(pendingChanges);
            const response = await fetch('/api/v1/channels', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channels })
            });

            if (response.ok) {
                const data = await response.json();
                pendingChanges = {};
                updateApplyAllButton();
                loadChannels(currentPage);
                showToast(data.message || `${count} channels updated`, 'success');
            } else {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to save changes', 'error');
            }
        } catch (error) {
            showToast('Failed to save changes', 'error');
        } finally {
            button.disabled = false;
            button.innerHTML = 'Apply All (<span id="changes-count">0</span>)';
            updateApplyAllButton();
        }
    }

    function highlightChangedRow(channelId) {
        const input = document.querySelector(`[data-channel-id="${channelId}"]`);
        if (input) {
            const row = input.closest('tr');
            if (row) {
                row.classList.add('bg-yellow-50');
            }
        }
    }

    async function applyRowChanges(channelId) {
        const changes = pendingChanges[channelId];
        if (!changes) return;

        try {
            const response = await fetch('/api/v1/channels', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channels: [changes] })
            });

            if (response.ok) {
                delete pendingChanges[channelId];
                updateApplyAllButton();
                loadChannels(currentPage);
                showToast('Channel updated', 'success');
            } else {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to save changes', 'error');
            }
        } catch (error) {
            showToast('Failed to save changes', 'error');
        }
    }

    async function editChannel(channelId) {
        const response = await fetch(`/api/v1/channels/${channelId}`);
        const data = await response.json();
        const channel = data.data;
        currentChannelId = channelId;

        const content = `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Stream Name</label>
                    <input type="text" id="edit-stream-name" value="${escapeHtml(channel.stream_name)}" readonly
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Display Name</label>
                    <input type="text" id="edit-display-name" value="${escapeHtml(channel.display_name || '')}" readonly
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Channel #</label>
                        <input type="number" id="edit-channel-number" value="${channel.channel_number || ''}" min="0" max="9999"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Archive Days</label>
                        <input type="number" id="edit-catchup-days" value="${channel.catchup_days || ''}" min="0" max="365"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">TVG ID (EPG ID)</label>
                    <input type="text" id="edit-tvg-id" value="${escapeHtml(channel.tvg_id || '')}"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Logo URL</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <img id="edit-logo-preview" src="${channel.tvg_logo || ''}" alt="" class="w-16 h-16 object-contain border rounded ${channel.tvg_logo ? '' : 'hidden'}">
                        <input type="file" id="edit-logo-file" accept="image/*" class="hidden">
                        <button type="button" onclick="document.getElementById('edit-logo-file').click()"
                                class="px-3 py-2 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50">
                            Choose File
                        </button>
                        <button type="button" onclick="clearEditLogo()"
                                class="px-3 py-2 border border-red-300 rounded-md text-sm text-red-700 hover:bg-red-50">
                            Remove
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Group</label>
                    <select id="edit-group" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">No Group</option>
                        ${groups.map(g => `<option value="${g.id}" ${channel.group_id === g.id ? 'selected' : ''}>${escapeHtml(g.name)}</option>`).join('')}
                    </select>
                </div>
            </div>
        `;

        showModal(`Edit: ${channel.display_name || channel.stream_name}`, content, [
            { text: 'Cancel', class: 'bg-gray-200 text-gray-800 hover:bg-gray-300', onclick: 'closeModal()' },
            { text: 'Save', class: 'bg-blue-600 text-white hover:bg-blue-700', onclick: 'saveEditChannel()' }
        ]);

        document.getElementById('edit-logo-file').addEventListener('change', handleEditLogoUpload);
    }

    function handleEditLogoUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('edit-logo-preview');
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function clearEditLogo() {
        const preview = document.getElementById('edit-logo-preview');
        preview.src = '';
        preview.classList.add('hidden');
        document.getElementById('edit-logo-file').value = '';
    }

    async function saveEditChannel() {
        const channelNumber = document.getElementById('edit-channel-number').value;
        const catchupDays = document.getElementById('edit-catchup-days').value;
        const tvgId = document.getElementById('edit-tvg-id').value;
        const preview = document.getElementById('edit-logo-preview');
        const tvgLogo = preview.classList.contains('hidden') ? '' : preview.src;
        const groupId = document.getElementById('edit-group').value;

        try {
            // Update channel fields
            const response = await fetch('/api/v1/channels', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    channels: [{
                        id: currentChannelId,
                        tvg_id: tvgId,
                        tvg_logo: tvgLogo,
                        channel_number: channelNumber ? parseInt(channelNumber) : null,
                        catchup_days: catchupDays ? parseInt(catchupDays) : null
                    }]
                })
            });

            if (!response.ok) {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to update channel', 'error');
                return;
            }

            // Update group if changed
            const groupResponse = await fetch(`/api/v1/channels/${currentChannelId}/group`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_id: groupId ? parseInt(groupId) : null })
            });

            if (groupResponse.ok) {
                closeModal();
                loadChannels(currentPage);
                showToast('Channel updated', 'success');
            } else {
                const data = await groupResponse.json();
                showToast(data.error?.message || 'Failed to update group', 'error');
            }
        } catch (error) {
            showToast('Failed to update channel', 'error');
        }
    }

    // Column resize functionality
    function initColumnResize() {
        const table = document.getElementById('channels-table');
        if (!table) return;

        // Set initial widths based on computed styles
        const headers = table.querySelectorAll('thead th');
        headers.forEach(th => {
            const width = th.offsetWidth;
            th.style.width = width + 'px';
        });

        const handles = table.querySelectorAll('.resize-handle');
        handles.forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const th = handle.parentElement;
                const startX = e.pageX;
                const startWidth = th.offsetWidth;

                handle.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                function onMouseMove(e) {
                    const newWidth = startWidth + (e.pageX - startX);
                    if (newWidth > 40) {
                        th.style.width = newWidth + 'px';
                    }
                }

                function onMouseUp() {
                    handle.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    function editLogo(channelId, currentLogo) {
        currentChannelId = channelId;

        const content = `
            <div class="space-y-4">
                <div class="flex items-center justify-center">
                    <img id="logo-preview" src="${currentLogo || ''}" alt="" class="w-32 h-32 object-contain border rounded ${currentLogo ? '' : 'hidden'}">
                    <div id="logo-placeholder" class="w-32 h-32 border-2 border-dashed border-gray-300 rounded flex items-center justify-center text-gray-400 ${currentLogo ? 'hidden' : ''}">
                        No logo
                    </div>
                </div>
                <div class="flex justify-center space-x-2">
                    <input type="file" id="logo-file-input" accept="image/*" class="hidden">
                    <button type="button" onclick="document.getElementById('logo-file-input').click()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50">
                        Choose File
                    </button>
                    <button type="button" onclick="clearLogoPreview()"
                            class="px-4 py-2 border border-red-300 rounded-md text-sm text-red-700 hover:bg-red-50">
                        Remove
                    </button>
                </div>
            </div>
        `;

        showModal('Edit Logo', content, [
            { text: 'Cancel', class: 'bg-gray-200 text-gray-800 hover:bg-gray-300', onclick: 'closeModal()' },
            { text: 'Apply', class: 'bg-blue-600 text-white hover:bg-blue-700', onclick: 'applyLogoChange()' }
        ]);

        document.getElementById('logo-file-input').addEventListener('change', handleLogoPreview);
    }

    function handleLogoPreview(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('logo-preview');
            const placeholder = document.getElementById('logo-placeholder');
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }

    function clearLogoPreview() {
        const preview = document.getElementById('logo-preview');
        const placeholder = document.getElementById('logo-placeholder');
        preview.src = '';
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        document.getElementById('logo-file-input').value = '';
    }

    function applyLogoChange() {
        const preview = document.getElementById('logo-preview');
        const logoValue = preview.classList.contains('hidden') ? '' : preview.src;

        trackChange(currentChannelId, 'tvg_logo', logoValue);
        closeModal();
        loadChannels(currentPage);
    }

    async function updateChannelGroup(channelId, groupId) {
        try {
            const response = await fetch(`/api/v1/channels/${channelId}/group`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_id: groupId ? parseInt(groupId) : null })
            });

            if (response.ok) {
                showToast('Group updated', 'success');
            } else {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to update group', 'error');
            }
        } catch (error) {
            showToast('Failed to update group', 'error');
        }
    }

    async function editChannelPackages(channelId) {
        const response = await fetch(`/api/v1/channels/${channelId}`);
        const data = await response.json();
        const channel = data.data;
        currentChannelId = channelId;

        const selectedIds = channel.packages.map(p => p.id);

        const content = `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Packages</label>
                <select id="packages-select" multiple class="w-full">
                    ${packages.map(p => `<option value="${p.id}" ${selectedIds.includes(p.id) ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
                </select>
            </div>
        `;

        showModal(`Edit Packages: ${channel.display_name || channel.stream_name}`, content, [
            { text: 'Cancel', class: 'bg-gray-200 text-gray-800 hover:bg-gray-300', onclick: 'closeModal()' },
            { text: 'Save', class: 'bg-blue-600 text-white hover:bg-blue-700', onclick: 'saveChannelPackages()' }
        ]);

        new TomSelect('#packages-select', { plugins: ['remove_button'] });
    }

    async function saveChannelPackages() {
        const select = document.getElementById('packages-select');
        const packageIds = Array.from(select.selectedOptions).map(o => parseInt(o.value));

        try {
            const response = await fetch(`/api/v1/channels/${currentChannelId}/packages`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ package_ids: packageIds })
            });

            if (response.ok) {
                closeModal();
                loadChannels(currentPage);
                showToast('Packages updated', 'success');
            } else {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to update packages', 'error');
            }
        } catch (error) {
            showToast('Failed to update packages', 'error');
        }
    }

    async function deleteChannel(channelId) {
        // Get channel info first
        const channelResponse = await fetch(`/api/v1/channels/${channelId}`);
        const channelData = await channelResponse.json();
        const channel = channelData.data;
        const isOrphaned = channel.sync_status === 'orphaned';

        const infoResponse = await fetch(`/api/v1/channels/${channelId}/cascade-info`);
        const infoData = await infoResponse.json();
        const info = infoData.data;

        const details = [];
        if (info.packages > 0) details.push(`${info.packages} packages`);
        if (info.users > 0) details.push(`${info.users} users`);

        let message = details.length > 0
            ? `This will remove it from: ${details.join(', ')}.`
            : 'This channel is not assigned to any packages or users.';

        if (!isOrphaned) {
            message += ' Warning: This channel is still synced with Flussonic and will reappear on next sync.';
        }

        showConfirm(
            'Delete Channel',
            `Are you sure you want to delete "${channel.display_name || channel.stream_name}"?`,
            message,
            async () => {
                try {
                    const url = isOrphaned
                        ? `/api/v1/channels/${channelId}`
                        : `/api/v1/channels/${channelId}?force=true`;
                    const response = await fetch(url, { method: 'DELETE' });
                    if (response.ok) {
                        loadChannels(currentPage);
                        showToast('Channel deleted', 'success');
                    } else {
                        const data = await response.json();
                        showToast(data.error?.message || 'Failed to delete channel', 'error');
                    }
                } catch (error) {
                    showToast('Failed to delete channel', 'error');
                }
            }
        );
    }

    async function syncChannels() {
        const button = document.getElementById('sync-button');
        button.disabled = true;
        button.textContent = 'Syncing...';

        try {
            const response = await fetch('/api/v1/channels/sync', { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
                showToast(`Sync complete: ${data.data.new} new, ${data.data.updated} updated, ${data.data.orphaned} orphaned`, 'success');
                loadChannels(1);
            } else {
                showToast(data.error?.message || 'Sync failed', 'error');
            }
        } catch (error) {
            showToast('Failed to sync channels', 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'Sync from Flussonic';
        }
    }
</script>
{% endblock %}
