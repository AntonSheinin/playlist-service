{% extends "base.html" %}

{% block title %}Channels - Playlist Service{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800">Channels</h1>
        <div class="flex space-x-2">
            <button onclick="applyAllChanges()" id="apply-all-button"
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 hidden">
                Apply All (<span id="changes-count">0</span>)
            </button>
            <button onclick="syncChannels()" id="sync-button"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Sync from Flussonic
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Group</label>
                <select id="filter-group" onchange="loadChannels()"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Groups</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Status</label>
                <select id="filter-status" onchange="loadChannels()"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="synced">Synced</option>
                    <option value="orphaned">Orphaned</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">Search</label>
                <input type="text" id="filter-search" placeholder="Search channels..."
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </div>

    <!-- Channels table -->
    <div class="bg-white rounded-lg shadow overflow-hidden overflow-x-auto">
        <table id="channels-table" class="min-w-full divide-y divide-gray-200 resizable-table" style="width: 100%;">
            <thead class="bg-gray-50">
                <tr>
                    <th data-col-key="number" class="w-16 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                        <button type="button" onclick="setSort('channel_number')" class="flex items-center gap-1 text-left w-full hover:text-gray-700">
                            <span>#</span>
                            <span class="sort-indicator text-gray-400" data-sort-indicator="channel_number"></span>
                        </button>
                        <span class="resize-handle"></span>
                    </th>
                    <th data-col-key="logo" class="w-14 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Logo<span class="resize-handle"></span></th>
                    <th data-col-key="name" class="min-w-[150px] px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                        <button type="button" onclick="setSort('display_name')" class="flex items-center gap-1 text-left w-full hover:text-gray-700">
                            <span>Name</span>
                            <span class="sort-indicator text-gray-400" data-sort-indicator="display_name"></span>
                        </button>
                        <span class="resize-handle"></span>
                    </th>
                    <th data-col-key="tvg-id" class="w-28 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                        <button type="button" onclick="setSort('tvg_id')" class="flex items-center gap-1 text-left w-full hover:text-gray-700">
                            <span>TVG ID</span>
                            <span class="sort-indicator text-gray-400" data-sort-indicator="tvg_id"></span>
                        </button>
                        <span class="resize-handle"></span>
                    </th>
                    <th data-col-key="group" class="w-32 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Groups<span class="resize-handle"></span></th>
                    <th data-col-key="archive" class="w-16 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                        <button type="button" onclick="setSort('catchup_days')" class="flex items-center gap-1 text-left w-full hover:text-gray-700">
                            <span>Archive</span>
                            <span class="sort-indicator text-gray-400" data-sort-indicator="catchup_days"></span>
                        </button>
                        <span class="resize-handle"></span>
                    </th>
                    <th data-col-key="packages" class="w-40 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Packages<span class="resize-handle"></span></th>
                    <th data-col-key="status" class="w-20 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                        <button type="button" onclick="setSort('sync_status')" class="flex items-center gap-1 text-left w-full hover:text-gray-700">
                            <span>Status</span>
                            <span class="sort-indicator text-gray-400" data-sort-indicator="sync_status"></span>
                        </button>
                        <span class="resize-handle"></span>
                    </th>
                    <th data-col-key="actions" class="w-24 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody id="channels-tbody" class="bg-white divide-y divide-gray-200">
                <!-- Rows loaded via JS -->
            </tbody>
        </table>

        <!-- Pagination -->
        <div id="pagination" class="px-4 py-3 border-t border-gray-200"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let currentPerPage = 20;
    let currentSortBy = 'channel_number';
    let currentSortDir = 'asc';
    let currentChannelId = null;
    let editGroupSelect = null;
    let groups = [];
    let packages = [];
    let searchTimeout = null;
    let pendingChanges = {};  // { channelId: { tvg_id, tvg_logo, channel_number } }
    let logoRemovalMode = null;
    const COLUMN_WIDTHS_KEY = 'channelsTableWidths';

    document.addEventListener('DOMContentLoaded', async () => {
        await Promise.all([loadGroups(), loadPackages()]);
        loadChannels();
        initColumnResize();
        updateSortIndicators();

        document.getElementById('filter-search').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadChannels(), 300);
        });
    });

    async function loadGroups() {
        const response = await fetch('/api/v1/lookup/groups');
        const data = await response.json();
        groups = data.data;

        const select = document.getElementById('filter-group');
        groups.forEach(g => {
            const option = document.createElement('option');
            option.value = g.id;
            option.textContent = g.name;
            select.appendChild(option);
        });
    }

    async function loadPackages() {
        const response = await fetch('/api/v1/lookup/packages');
        const data = await response.json();
        packages = data.data;
    }

    async function loadChannels(page = 1) {
        currentPage = page;
        const groupId = document.getElementById('filter-group').value;
        const status = document.getElementById('filter-status').value;
        const search = document.getElementById('filter-search').value;

        let url = `/api/v1/channels?page=${page}&per_page=${currentPerPage}&sort_by=${encodeURIComponent(currentSortBy)}&sort_dir=${currentSortDir}`;
        if (groupId) url += `&group_id=${groupId}`;
        if (status) url += `&sync_status=${status}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;

        try {
            const response = await fetch(url);
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            renderChannels(data.data);
        } catch (error) {
            console.error('Failed to load channels:', error);
            showToast('Failed to load channels', 'error');
        }
    }

    function renderChannels(data) {
        const tbody = document.getElementById('channels-tbody');
        tbody.innerHTML = '';

        data.items.forEach((channel, index) => {
            const pending = pendingChanges[channel.id] || {};
            const currentTvgId = pending.tvg_id !== undefined ? pending.tvg_id : (channel.tvg_id || '');
            const currentLogo = pending.tvg_logo !== undefined ? pending.tvg_logo : (channel.tvg_logo || '');
            const currentNumber = pending.channel_number !== undefined ? pending.channel_number : (channel.channel_number || '');
            const catchupDisplay = channel.catchup_days === null || channel.catchup_days === undefined
                ? '-'
                : String(channel.catchup_days);
            const catchupClass = catchupDisplay === '-' ? 'text-gray-400' : 'text-gray-700';
            const hasChanges = pendingChanges[channel.id] !== undefined;

            const assignedPackageIds = channel.packages.map(p => p.id);
            const assignedGroupIds = Array.isArray(channel.groups) ? channel.groups.map(g => g.id) : [];
            const row = document.createElement('tr');
            row.className = channel.sync_status === 'orphaned' ? 'bg-gray-50 text-gray-500' : '';
            if (hasChanges) row.classList.add('bg-yellow-50');
            row.innerHTML = `
                <td class="px-2 py-2">
                    <input type="number" min="0" max="9999"
                           value="${currentNumber}"
                           data-channel-id="${channel.id}"
                           data-field="channel_number"
                           data-original="${channel.channel_number || ''}"
                           onchange="trackChange(${channel.id}, 'channel_number', this.value)"
                           class="w-14 px-1 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </td>
                <td class="px-2 py-2">
                    ${currentLogo ?
                        `<img src="${currentLogo}" class="w-8 h-8 object-contain cursor-pointer" onclick="editLogo(${channel.id}, '${escapeHtml(currentLogo)}')" title="Click to change">` :
                        `<button onclick="editLogo(${channel.id}, '')" class="w-8 h-8 border border-dashed border-gray-300 rounded flex items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 text-xs" title="Add logo">+</button>`}
                </td>
                <td class="px-2 py-2">
                    <div class="font-medium text-sm">${escapeHtml(channel.display_name || channel.stream_name)}</div>
                    <div class="text-xs text-gray-500">${escapeHtml(channel.stream_name)}</div>
                </td>
                <td class="px-2 py-2">
                    <input type="text"
                           value="${escapeHtml(currentTvgId)}"
                           data-channel-id="${channel.id}"
                           data-field="tvg_id"
                           data-original="${escapeHtml(channel.tvg_id || '')}"
                           onchange="trackChange(${channel.id}, 'tvg_id', this.value)"
                           placeholder="-"
                           class="w-24 px-1 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </td>
                <td class="px-2 py-2">
                    ${groups.length > 0
                        ? `<select id="channel-groups-${channel.id}"
                                   data-channel-id="${channel.id}"
                                   class="channel-groups-select w-full"
                                   multiple>
                               ${groups.map(g => `<option value="${g.id}" ${assignedGroupIds.includes(g.id) ? 'selected' : ''}>${escapeHtml(g.name)}</option>`).join('')}
                           </select>`
                        : '<div class="text-xs text-gray-400">No groups</div>'}
                </td>
                <td class="px-2 py-2">
                    <span class="text-sm ${catchupClass}">${escapeHtml(catchupDisplay)}</span>
                </td>
                <td class="px-2 py-2">
                    ${packages.length > 0
                        ? `<select id="channel-packages-${channel.id}"
                                   data-channel-id="${channel.id}"
                                   class="channel-packages-select w-full"
                                   multiple>
                               ${packages.map(p => `<option value="${p.id}" ${assignedPackageIds.includes(p.id) ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
                           </select>`
                        : '<div class="text-xs text-gray-400">No packages</div>'}
                </td>
                <td class="px-2 py-2">
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium ${channel.sync_status === 'synced' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                        ${channel.sync_status === 'synced' ? 'sync' : 'orph'}
                    </span>
                </td>
                <td class="px-2 py-2">
                    <div class="flex items-center space-x-1">
                        <button onclick="applyRowChanges(${channel.id})" class="text-xs px-2 py-1 rounded ${hasChanges ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" title="Save changes" ${hasChanges ? '' : 'disabled'}>Apply</button>
                        <button onclick="editChannel(${channel.id})" class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" title="Edit channel details">Edit</button>
                        <button onclick="deleteChannel(${channel.id})" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700" title="Delete channel">Delete</button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        initChannelGroupSelects();
        initChannelPackageSelects();
        renderPagination(data);
    }

    function normalizeMultiValues(values) {
        if (Array.isArray(values)) {
            return values;
        }
        if (!values) {
            return [];
        }
        return String(values)
            .split(',')
            .map(value => value.trim())
            .filter(Boolean);
    }

    function initChannelGroupSelects() {
        const selects = document.querySelectorAll('.channel-groups-select');
        if (!selects.length || typeof TomSelect === 'undefined') return;

        selects.forEach(select => {
            if (select.tomselect) {
                select.tomselect.destroy();
            }

            const channelId = parseInt(select.dataset.channelId, 10);
            let ready = false;

            const instance = new TomSelect(select, {
                plugins: ['remove_button'],
                maxOptions: 1000,
                dropdownParent: 'body',
                onChange: (value) => {
                    if (!ready) return;
                    const ids = normalizeMultiValues(value).map(v => parseInt(v, 10)).filter(Boolean);
                    updateChannelGroupsInline(channelId, ids);
                }
            });

            ready = true;
            select.tomselect = instance;
        });
    }

    function initChannelPackageSelects() {
        const selects = document.querySelectorAll('.channel-packages-select');
        if (!selects.length || typeof TomSelect === 'undefined') return;

        selects.forEach(select => {
            if (select.tomselect) {
                select.tomselect.destroy();
            }

            const channelId = parseInt(select.dataset.channelId, 10);
            let ready = false;

            const instance = new TomSelect(select, {
                plugins: ['remove_button'],
                maxOptions: 1000,
                dropdownParent: 'body',
                onChange: (value) => {
                    if (!ready) return;
                    const ids = normalizeMultiValues(value).map(v => parseInt(v, 10)).filter(Boolean);
                    updateChannelPackagesInline(channelId, ids);
                }
            });

            ready = true;
            select.tomselect = instance;
        });
    }

    async function persistChannelGroups(channelId, groupIds) {
        const response = await fetch(`/api/v1/channels/${channelId}/groups`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ group_ids: groupIds })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error?.message || 'Failed to update groups');
        }

        return data.data;
    }

    async function updateChannelGroupsInline(channelId, groupIds) {
        try {
            await persistChannelGroups(channelId, groupIds);
            showToast('Groups updated', 'success');
        } catch (error) {
            showToast(error.message || 'Failed to update groups', 'error');
            loadChannels(currentPage);
        }
    }

    async function persistChannelPackages(channelId, packageIds) {
        const response = await fetch(`/api/v1/channels/${channelId}/packages`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ package_ids: packageIds })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error?.message || 'Failed to update packages');
        }

        return data.data;
    }

    async function updateChannelPackagesInline(channelId, packageIds) {
        try {
            await persistChannelPackages(channelId, packageIds);
            showToast('Packages updated', 'success');
        } catch (error) {
            showToast(error.message || 'Failed to update packages', 'error');
            loadChannels(currentPage);
        }
    }

    function setSort(field) {
        if (currentSortBy === field) {
            currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortBy = field;
            currentSortDir = 'asc';
        }
        updateSortIndicators();
        loadChannels(1);
    }

    function updateSortIndicators() {
        const indicators = document.querySelectorAll('[data-sort-indicator]');
        indicators.forEach(indicator => {
            const field = indicator.dataset.sortIndicator;
            if (field === currentSortBy) {
                indicator.textContent = currentSortDir === 'asc' ? '▲' : '▼';
            } else {
                indicator.textContent = '';
            }
        });
    }

    function renderPagination(data) {
        const container = document.getElementById('pagination');
        const perPageOptions = [10, 20, 50, 100];

        let html = '<div class="flex items-center justify-between"><div class="text-sm text-gray-700">';
        html += `Page ${data.page} of ${data.pages} (${data.total} channels)</div>`;
        html += '<div class="flex items-center space-x-4">';
        html += '<div class="flex items-center space-x-2">';
        html += '<span class="text-sm text-gray-700">Per page</span>';
        html += `<select id="per-page-select" class="px-2 py-1 border rounded text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">`;
        html += perPageOptions.map(value => `<option value="${value}" ${value === currentPerPage ? 'selected' : ''}>${value}</option>`).join('');
        html += '</select></div>';
        html += '<div class="flex space-x-2">';

        if (data.page > 1) {
            html += `<button onclick="loadChannels(1)" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">First</button>`;
            html += `<button onclick="loadChannels(${data.page - 1})" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Previous</button>`;
        }
        if (data.page < data.pages) {
            html += `<button onclick="loadChannels(${data.page + 1})" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Next</button>`;
            html += `<button onclick="loadChannels(${data.pages})" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Last</button>`;
        }

        html += '</div></div></div>';
        container.innerHTML = html;

        const perPageSelect = document.getElementById('per-page-select');
        if (perPageSelect) {
            perPageSelect.addEventListener('change', () => {
                currentPerPage = parseInt(perPageSelect.value);
                loadChannels(1);
            });
        }
    }

    function trackChange(channelId, field, value) {
        if (!pendingChanges[channelId]) {
            pendingChanges[channelId] = { id: channelId };
        }

        if (field === 'channel_number') {
            pendingChanges[channelId][field] = value ? parseInt(value) : null;
        } else {
            pendingChanges[channelId][field] = value;
        }

        highlightChangedRow(channelId);
        updateApplyAllButton();
        loadChannels(currentPage);  // Re-render to show Apply button
    }

    function updateApplyAllButton() {
        const count = Object.keys(pendingChanges).length;
        const button = document.getElementById('apply-all-button');
        const countSpan = document.getElementById('changes-count');

        if (count > 0) {
            button.classList.remove('hidden');
            countSpan.textContent = count;
        } else {
            button.classList.add('hidden');
        }
    }

    async function uploadChannelLogo(channelId, file) {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`/api/v1/channels/${channelId}/logo`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error?.message || 'Failed to upload logo');
        }

        return data.data.url || '';
    }

    async function uploadChannelLogoByUrl(channelId, logoUrl) {
        const response = await fetch(`/api/v1/channels/${channelId}/logo-url`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: logoUrl })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error?.message || 'Failed to upload logo');
        }

        return data.data.url || '';
    }

    async function setChannelLogo(channelId, logoUrl) {
        const payload = { tvg_logo: logoUrl == null ? '' : logoUrl };
        const response = await fetch(`/api/v1/channels/${channelId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error?.message || 'Failed to update logo');
        }

        return data.data.tvg_logo || '';
    }

    async function removeChannelLogo(channelId, deleteFile) {
        const response = await fetch(`/api/v1/channels/${channelId}/logo?delete_file=${deleteFile ? 'true' : 'false'}`, {
            method: 'DELETE'
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error?.message || 'Failed to remove logo');
        }

        return data.message || 'Logo removed';
    }

    async function applyAllChanges() {
        const count = Object.keys(pendingChanges).length;
        if (count === 0) return;

        const button = document.getElementById('apply-all-button');
        button.disabled = true;
        button.textContent = 'Saving...';

        try {
            const channels = Object.values(pendingChanges);
            const response = await fetch('/api/v1/channels', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channels })
            });

            if (response.ok) {
                const data = await response.json();
                pendingChanges = {};
                updateApplyAllButton();
                loadChannels(currentPage);
                showToast(data.message || `${count} channels updated`, 'success');
            } else {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to save changes', 'error');
            }
        } catch (error) {
            showToast('Failed to save changes', 'error');
        } finally {
            button.disabled = false;
            button.innerHTML = 'Apply All (<span id="changes-count">0</span>)';
            updateApplyAllButton();
        }
    }

    function highlightChangedRow(channelId) {
        const input = document.querySelector(`[data-channel-id="${channelId}"]`);
        if (input) {
            const row = input.closest('tr');
            if (row) {
                row.classList.add('bg-yellow-50');
            }
        }
    }

    async function applyRowChanges(channelId) {
        const changes = pendingChanges[channelId];
        if (!changes) return;

        try {
            const response = await fetch('/api/v1/channels', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channels: [changes] })
            });

            if (response.ok) {
                delete pendingChanges[channelId];
                updateApplyAllButton();
                loadChannels(currentPage);
                showToast('Channel updated', 'success');
            } else {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to save changes', 'error');
            }
        } catch (error) {
            showToast('Failed to save changes', 'error');
        }
    }

    async function editChannel(channelId) {
        const response = await fetch(`/api/v1/channels/${channelId}`);
        const data = await response.json();
        const channel = data.data;
        const catchupDisplay = channel.catchup_days === null || channel.catchup_days === undefined
            ? '-'
            : String(channel.catchup_days);
        const assignedGroupIds = Array.isArray(channel.groups) ? channel.groups.map(g => g.id) : [];
        currentChannelId = channelId;

        const content = `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Stream Name</label>
                    <input type="text" id="edit-stream-name" value="${escapeHtml(channel.stream_name)}" readonly
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Display Name</label>
                    <input type="text" id="edit-display-name" value="${escapeHtml(channel.display_name || '')}" readonly
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Channel #</label>
                        <input type="number" id="edit-channel-number" value="${channel.channel_number || ''}" min="0" max="9999"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Archive Days</label>
                        <div class="mt-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500 text-sm">
                            ${escapeHtml(catchupDisplay)}
                        </div>
                        <p class="mt-1 text-xs text-gray-400">Imported from Flussonic.</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">TVG ID (EPG ID)</label>
                    <input type="text" id="edit-tvg-id" value="${escapeHtml(channel.tvg_id || '')}"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Logo</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <img id="edit-logo-preview" src="${channel.tvg_logo || ''}" alt="" class="w-16 h-16 object-contain border rounded ${channel.tvg_logo ? '' : 'hidden'}">
                        <input type="file" id="edit-logo-file" accept="image/*" class="hidden">
                        <button type="button" onclick="document.getElementById('edit-logo-file').click()"
                                class="px-3 py-2 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50">
                            Choose File
                        </button>
                        <button type="button" onclick="clearEditLogo()"
                                class="px-3 py-2 border border-red-300 rounded-md text-sm text-red-700 hover:bg-red-50">
                            Remove
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Groups</label>
                    <select id="edit-group" multiple class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        ${groups.map(g => `<option value="${g.id}" ${assignedGroupIds.includes(g.id) ? 'selected' : ''}>${escapeHtml(g.name)}</option>`).join('')}
                    </select>
                </div>
            </div>
        `;

        showModal(`Edit: ${channel.display_name || channel.stream_name}`, content, [
            { text: 'Cancel', class: 'bg-gray-200 text-gray-800 hover:bg-gray-300', onclick: 'closeModal()' },
            { text: 'Save', class: 'bg-blue-600 text-white hover:bg-blue-700', onclick: 'saveEditChannel()' }
        ]);

        document.getElementById('edit-logo-file').addEventListener('change', handleEditLogoUpload);
        if (editGroupSelect) {
            editGroupSelect.destroy();
        }
        if (groups.length > 0 && typeof TomSelect !== 'undefined') {
            editGroupSelect = new TomSelect('#edit-group', { plugins: ['remove_button'], dropdownParent: 'body' });
        } else {
            editGroupSelect = null;
        }
    }

    function handleEditLogoUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const preview = document.getElementById('edit-logo-preview');
        if (preview.dataset.objectUrl) {
            URL.revokeObjectURL(preview.dataset.objectUrl);
        }
        const objectUrl = URL.createObjectURL(file);
        preview.dataset.objectUrl = objectUrl;
        preview.src = objectUrl;
        preview.classList.remove('hidden');
    }

    function clearEditLogo() {
        const preview = document.getElementById('edit-logo-preview');
        if (preview.dataset.objectUrl) {
            URL.revokeObjectURL(preview.dataset.objectUrl);
            preview.dataset.objectUrl = '';
        }
        preview.src = '';
        preview.classList.add('hidden');
        document.getElementById('edit-logo-file').value = '';
    }

    async function saveEditChannel() {
        const channelNumber = document.getElementById('edit-channel-number').value;
        const tvgId = document.getElementById('edit-tvg-id').value;
        const preview = document.getElementById('edit-logo-preview');
        const fileInput = document.getElementById('edit-logo-file');
        let tvgLogo = preview.classList.contains('hidden') ? '' : preview.src;
        const groupSelect = document.getElementById('edit-group');
        const groupIds = editGroupSelect
            ? normalizeMultiValues(editGroupSelect.getValue()).map(v => parseInt(v, 10)).filter(Boolean)
            : groupSelect
                ? Array.from(groupSelect.selectedOptions).map(option => parseInt(option.value, 10)).filter(Boolean)
                : [];

        try {
            if (fileInput.files && fileInput.files[0]) {
                tvgLogo = await uploadChannelLogo(currentChannelId, fileInput.files[0]);
                if (preview.dataset.objectUrl) {
                    URL.revokeObjectURL(preview.dataset.objectUrl);
                    preview.dataset.objectUrl = '';
                }
                preview.src = tvgLogo;
                preview.classList.remove('hidden');
                fileInput.value = '';
            }

            // Update channel fields
            const response = await fetch('/api/v1/channels', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    channels: [{
                        id: currentChannelId,
                        tvg_id: tvgId,
                        tvg_logo: tvgLogo,
                        channel_number: channelNumber ? parseInt(channelNumber) : null
                    }]
                })
            });

            if (!response.ok) {
                const data = await response.json();
                showToast(data.error?.message || 'Failed to update channel', 'error');
                return;
            }

            // Update group if changed
            const groupResponse = await fetch(`/api/v1/channels/${currentChannelId}/groups`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_ids: groupIds })
            });

            if (groupResponse.ok) {
                closeModal();
                loadChannels(currentPage);
                showToast('Channel updated', 'success');
            } else {
                const data = await groupResponse.json();
                showToast(data.error?.message || 'Failed to update groups', 'error');
            }
        } catch (error) {
            showToast(error.message || 'Failed to update channel', 'error');
        }
    }

    // Column resize functionality
    function loadColumnWidths() {
        try {
            const raw = localStorage.getItem(COLUMN_WIDTHS_KEY);
            return raw ? JSON.parse(raw) : {};
        } catch (error) {
            return {};
        }
    }

    function saveColumnWidths(widths) {
        try {
            localStorage.setItem(COLUMN_WIDTHS_KEY, JSON.stringify(widths));
        } catch (error) {
            // Ignore storage failures (private mode or disabled storage).
        }
    }

    function initColumnResize() {
        const table = document.getElementById('channels-table');
        if (!table) return;

        // Set initial widths based on computed styles
        const headers = table.querySelectorAll('thead th');
        const storedWidths = loadColumnWidths();
        headers.forEach(th => {
            const key = th.dataset.colKey;
            if (key && storedWidths[key]) {
                th.style.width = storedWidths[key] + 'px';
                return;
            }
            const width = th.offsetWidth;
            th.style.width = width + 'px';
        });

        const handles = table.querySelectorAll('.resize-handle');
        handles.forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const th = handle.parentElement;
                const startX = e.pageX;
                const startWidth = th.offsetWidth;

                handle.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                function onMouseMove(e) {
                    const newWidth = startWidth + (e.pageX - startX);
                    if (newWidth > 40) {
                        th.style.width = newWidth + 'px';
                    }
                }

                function onMouseUp() {
                    handle.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);

                    const key = th.dataset.colKey;
                    if (key) {
                        const widths = loadColumnWidths();
                        widths[key] = th.offsetWidth;
                        saveColumnWidths(widths);
                    }
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    function editLogo(channelId, currentLogo) {
        currentChannelId = channelId;
        logoRemovalMode = null;

        const content = `
            <div class="space-y-4">
                <div class="flex items-center justify-center">
                    <img id="logo-preview" src="${currentLogo || ''}" alt="" class="w-32 h-32 object-contain border rounded ${currentLogo ? '' : 'hidden'}">
                    <div id="logo-placeholder" class="w-32 h-32 border-2 border-dashed border-gray-300 rounded flex items-center justify-center text-gray-400 ${currentLogo ? 'hidden' : ''}">
                        No logo
                    </div>
                </div>
                <div class="flex justify-center space-x-2">
                    <input type="file" id="logo-file-input" accept="image/*" class="hidden">
                    <button type="button" onclick="document.getElementById('logo-file-input').click()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50">
                        Choose File
                    </button>
                    <button type="button" onclick="markLogoRemoval('db')"
                            class="px-4 py-2 border border-red-300 rounded-md text-sm text-red-700 hover:bg-red-50">
                        Remove URL
                    </button>
                    <button type="button" onclick="markLogoRemoval('delete')"
                            class="px-4 py-2 bg-red-600 text-white rounded-md text-sm hover:bg-red-700">
                        Remove + Delete File
                    </button>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500">Or paste logo URL</label>
                    <input type="text" id="logo-url-input" value="${escapeHtml(currentLogo || '')}"
                           placeholder="https://example.com/logo.png"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        `;

        showModal('Edit Logo', content, [
            { text: 'Cancel', class: 'bg-gray-200 text-gray-800 hover:bg-gray-300', onclick: 'closeModal()' },
            { text: 'Apply', class: 'bg-blue-600 text-white hover:bg-blue-700', onclick: 'applyLogoChange()' }
        ]);

        document.getElementById('logo-file-input').addEventListener('change', handleLogoPreview);
        document.getElementById('logo-url-input').addEventListener('input', handleLogoUrlInput);
    }

    function handleLogoPreview(e) {
        const file = e.target.files[0];
        if (!file) return;
        logoRemovalMode = null;

        const urlInput = document.getElementById('logo-url-input');
        if (urlInput) {
            urlInput.value = '';
        }

        const preview = document.getElementById('logo-preview');
        const placeholder = document.getElementById('logo-placeholder');
        if (preview.dataset.objectUrl) {
            URL.revokeObjectURL(preview.dataset.objectUrl);
        }
        const objectUrl = URL.createObjectURL(file);
        preview.dataset.objectUrl = objectUrl;
        preview.src = objectUrl;
        preview.classList.remove('hidden');
        placeholder.classList.add('hidden');
    }

    function handleLogoUrlInput(e) {
        const url = e.target.value.trim();
        const preview = document.getElementById('logo-preview');
        const placeholder = document.getElementById('logo-placeholder');
        const fileInput = document.getElementById('logo-file-input');
        logoRemovalMode = null;

        if (preview.dataset.objectUrl) {
            URL.revokeObjectURL(preview.dataset.objectUrl);
            preview.dataset.objectUrl = '';
        }
        if (fileInput) {
            fileInput.value = '';
        }

        if (url) {
            preview.src = url;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
        } else {
            preview.src = '';
            preview.classList.add('hidden');
            placeholder.classList.remove('hidden');
        }
    }

    function clearLogoPreview() {
        const preview = document.getElementById('logo-preview');
        const placeholder = document.getElementById('logo-placeholder');
        if (preview.dataset.objectUrl) {
            URL.revokeObjectURL(preview.dataset.objectUrl);
            preview.dataset.objectUrl = '';
        }
        preview.src = '';
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        document.getElementById('logo-file-input').value = '';
        const urlInput = document.getElementById('logo-url-input');
        if (urlInput) {
            urlInput.value = '';
        }
    }

    function markLogoRemoval(mode) {
        logoRemovalMode = mode;
        clearLogoPreview();
    }

    async function applyLogoChange() {
        const preview = document.getElementById('logo-preview');
        const fileInput = document.getElementById('logo-file-input');
        const placeholder = document.getElementById('logo-placeholder');
        const urlInput = document.getElementById('logo-url-input');
        const urlValue = urlInput ? urlInput.value.trim() : '';
        let logoValue = preview.classList.contains('hidden') ? '' : preview.src;
        let message = 'Logo updated';

        try {
            if (logoRemovalMode) {
                message = await removeChannelLogo(currentChannelId, logoRemovalMode === 'delete');
                logoValue = '';
            } else if (fileInput.files && fileInput.files[0]) {
                logoValue = await uploadChannelLogo(currentChannelId, fileInput.files[0]);
                if (preview.dataset.objectUrl) {
                    URL.revokeObjectURL(preview.dataset.objectUrl);
                    preview.dataset.objectUrl = '';
                }
                preview.src = logoValue;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                fileInput.value = '';
                if (urlInput) {
                    urlInput.value = '';
                }
            } else if (urlValue) {
                logoValue = await uploadChannelLogoByUrl(currentChannelId, urlValue);
                preview.src = logoValue;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else if (preview.classList.contains('hidden')) {
                await setChannelLogo(currentChannelId, '');
                logoValue = '';
            } else {
                closeModal();
                return;
            }
        } catch (error) {
            showToast(error.message || 'Failed to upload logo', 'error');
            return;
        }

        if (pendingChanges[currentChannelId]) {
            delete pendingChanges[currentChannelId].tvg_logo;
            if (Object.keys(pendingChanges[currentChannelId]).length === 1) {
                delete pendingChanges[currentChannelId];
            }
            updateApplyAllButton();
        }

        logoRemovalMode = null;
        closeModal();
        loadChannels(currentPage);
        showToast(message, 'success');
    }

    async function editChannelPackages(channelId) {
        const response = await fetch(`/api/v1/channels/${channelId}`);
        const data = await response.json();
        const channel = data.data;
        currentChannelId = channelId;

        const selectedIds = channel.packages.map(p => p.id);

        const content = `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Packages</label>
                <select id="packages-select" multiple class="w-full">
                    ${packages.map(p => `<option value="${p.id}" ${selectedIds.includes(p.id) ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
                </select>
            </div>
        `;

        showModal(`Edit Packages: ${channel.display_name || channel.stream_name}`, content, [
            { text: 'Cancel', class: 'bg-gray-200 text-gray-800 hover:bg-gray-300', onclick: 'closeModal()' },
            { text: 'Save', class: 'bg-blue-600 text-white hover:bg-blue-700', onclick: 'saveChannelPackages()' }
        ]);

        new TomSelect('#packages-select', { plugins: ['remove_button'] });
    }

    async function saveChannelPackages() {
        const select = document.getElementById('packages-select');
        const packageIds = Array.from(select.selectedOptions).map(o => parseInt(o.value));

        try {
            await persistChannelPackages(currentChannelId, packageIds);
            closeModal();
            loadChannels(currentPage);
            showToast('Packages updated', 'success');
        } catch (error) {
            showToast(error.message || 'Failed to update packages', 'error');
        }
    }

    async function deleteChannel(channelId) {
        // Get channel info first
        const channelResponse = await fetch(`/api/v1/channels/${channelId}`);
        const channelData = await channelResponse.json();
        const channel = channelData.data;
        const isOrphaned = channel.sync_status === 'orphaned';

        const infoResponse = await fetch(`/api/v1/channels/${channelId}/cascade-info`);
        const infoData = await infoResponse.json();
        const info = infoData.data;

        const details = [];
        if (info.packages > 0) details.push(`${info.packages} packages`);
        if (info.users > 0) details.push(`${info.users} users`);

        let message = details.length > 0
            ? `This will remove it from: ${details.join(', ')}.`
            : 'This channel is not assigned to any packages or users.';

        if (!isOrphaned) {
            message += ' Warning: This channel is still synced with Flussonic and will reappear on next sync.';
        }

        showConfirm(
            'Delete Channel',
            `Are you sure you want to delete "${channel.display_name || channel.stream_name}"?`,
            message,
            async () => {
                try {
                    const url = isOrphaned
                        ? `/api/v1/channels/${channelId}`
                        : `/api/v1/channels/${channelId}?force=true`;
                    const response = await fetch(url, { method: 'DELETE' });
                    if (response.ok) {
                        loadChannels(currentPage);
                        showToast('Channel deleted', 'success');
                    } else {
                        const data = await response.json();
                        showToast(data.error?.message || 'Failed to delete channel', 'error');
                    }
                } catch (error) {
                    showToast('Failed to delete channel', 'error');
                }
            }
        );
    }

    async function syncChannels() {
        const button = document.getElementById('sync-button');
        button.disabled = true;
        button.textContent = 'Syncing...';

        try {
            const response = await fetch('/api/v1/channels/sync', { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
                showToast(`Sync complete: ${data.data.new} new, ${data.data.updated} updated, ${data.data.orphaned} orphaned`, 'success');
                loadChannels(1);
            } else {
                showToast(data.error?.message || 'Sync failed', 'error');
            }
        } catch (error) {
            showToast('Failed to sync channels', 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'Sync from Flussonic';
        }
    }
</script>
{% endblock %}
